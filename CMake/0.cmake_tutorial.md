# CMake入门教程 - 以algorithm_base项目为例

## 1. CMake基础概念

CMake是一个跨平台的构建系统生成器，它允许开发者使用简单的文本文件（CMakeLists.txt）来描述项目的构建过程，然后根据不同的平台和编译器生成相应的构建文件（如Makefile、Visual Studio项目等）。

### 1.1 核心概念
- **项目（Project）**：一个CMake构建的基本单位
- **目标（Target）**：构建的产物，如可执行文件、库等
- **依赖（Dependency）**：项目所依赖的外部库或模块
- **变量（Variable）**：用于存储配置信息的命名值
- **命令（Command）**：执行特定操作的指令

## 2. algorithm_base项目结构

```
algorithm_base/
├── CMakeLists.txt          # 主配置文件
├── cmake/
│   └── algorithm_baseConfig.cmake.in  # 包配置模板
├── inc/                   # 头文件目录
├── src/                   # 源文件目录
└── test/                  # 测试目录
    ├── CMakeLists.txt
    └── gtest/
        └── CMakeLists.txt
```

## 3. 主CMakeLists.txt解析

### 3.1 项目初始化

```cmake
cmake_minimum_required(VERSION 3.15)

project(algorithm_base LANGUAGES C CXX VERSION 1.0.0)
```

- **cmake_minimum_required**：指定所需的CMake最低版本
- **project**：定义项目名称、支持的语言和版本
  - `LANGUAGES C CXX`：项目同时支持C和C++
  - `VERSION 1.0.0`：设置项目版本号

### 3.2 编译选项配置

```cmake
if(CMAKE_CXX_COMPILER_ID MATCHES "GNU")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -Werror -Wno-error=deprecated-declarations")
else()
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS}")
endif()
set(CMAKE_CXX_STANDARD 14) 
```

- **条件判断**：根据不同的编译器设置不同的编译标志
- **CMAKE_CXX_COMPILER_ID**：自动变量，存储当前使用的C++编译器ID
- **set**：设置变量值
  - `CMAKE_CXX_FLAGS`：C++编译器标志
  - `-Wall -Wextra -Werror`：开启所有警告并将警告视为错误
- **CMAKE_CXX_STANDARD**：设置C++标准版本

### 3.3 依赖查找

```cmake
find_package(zos_scripts REQUIRED)
find_package(basic_types REQUIRED)
find_package(Eigen3 REQUIRED)
```

- **find_package**：查找并加载外部依赖包
  - `REQUIRED`：表示该依赖是必须的，如果找不到会导致构建失败
  - 找到的依赖通常会提供导入目标（如`Eigen3::Eigen`）

### 3.4 库构建

```cmake
ZOS_COMPILE_LIB(
    ${PROJECT_NAME} 
    SOURCES
    src/numerics/eigen_solver.cpp
    src/numerics/utility.cpp
    src/numerics/spline.cpp
    src/geometry/point3_spline.cpp
    src/geometry/geographical_transformation.cpp
    INCLUDES
    $<BUILD_INTERFACE:${PROJECT_SOURCE_DIR}/inc>
    $<INSTALL_INTERFACE:include/${PROJECT_NAME}>
    LIBRARIES
    zos::basic_types
    Eigen3::Eigen
    INSTALL_DIR
    lib
    NAMESPACE
    zos
)
```

- **ZOS_COMPILE_LIB**：自定义宏（由zos_scripts提供），用于简化库的构建过程
  - `SOURCES`：指定源文件列表
  - `INCLUDES`：指定头文件搜索路径
    - `$<BUILD_INTERFACE:>`：仅在构建时使用的路径
    - `$<INSTALL_INTERFACE:>`：仅在安装时使用的路径
    - 这种写法支持构建树和安装树的不同路径
  - `LIBRARIES`：指定依赖的库
  - `INSTALL_DIR`：指定安装目录
  - `NAMESPACE`：指定库的命名空间

### 3.5 测试配置

```cmake
enable_testing()
add_subdirectory(test)
```

- **enable_testing**：启用测试支持
- **add_subdirectory**：添加子目录，CMake会处理该目录下的CMakeLists.txt

### 3.6 包配置和安装

```cmake
include(CMakePackageConfigHelpers)
write_basic_package_version_file(
    "${PROJECT_BINARY_DIR}/${PROJECT_NAME}ConfigVersion.cmake"
        VERSION ${PROJECT_VERSION}
        COMPATIBILITY AnyNewerVersion
        )
configure_package_config_file(
    "${PROJECT_SOURCE_DIR}/cmake/${PROJECT_NAME}Config.cmake.in"
    "${PROJECT_BINARY_DIR}/${PROJECT_NAME}Config.cmake"
    INSTALL_DESTINATION lib/cmake/${PROJECT_NAME}
    )
```

- **CMakePackageConfigHelpers**：提供了创建包配置文件的辅助函数
- **write_basic_package_version_file**：生成版本配置文件
  - `COMPATIBILITY AnyNewerVersion`：表示任何新版本都兼容
- **configure_package_config_file**：根据模板生成包配置文件

```cmake
install(FILES "${PROJECT_BINARY_DIR}/${PROJECT_NAME}ConfigVersion.cmake"
              "${PROJECT_BINARY_DIR}/${PROJECT_NAME}Config.cmake"
              DESTINATION lib/cmake/${PROJECT_NAME})
install(DIRECTORY ${PROJECT_SOURCE_DIR}/inc/ DESTINATION include/${PROJECT_NAME})
```

- **install**：指定安装规则
  - 安装包配置文件到`lib/cmake/${PROJECT_NAME}`
  - 安装头文件到`include/${PROJECT_NAME}`

## 4. 包配置模板（algorithm_baseConfig.cmake.in）

```cmake
@PACKAGE_INIT@

find_package(basic_types REQUIRED)
find_package(Eigen3 REQUIRED)
find_package(zos_scripts REQUIRED)

include("${CMAKE_CURRENT_LIST_DIR}/@PROJECT_NAME@-targets.cmake")
check_required_components("@PROJECT_NAME@")
```

- **@PACKAGE_INIT@**：CMake变量占位符，会在生成时被替换
- **find_package**：列出该包的依赖
- **include**：包含生成的目标文件
- **check_required_components**：检查所有必需的组件是否都存在

## 5. 测试配置

### 5.1 test/CMakeLists.txt

```cmake
add_subdirectory(gtest)
```

简单地添加gtest子目录

### 5.2 test/gtest/CMakeLists.txt

```cmake
find_package(GTest QUIET)

set(lib_support GTest::GTest algorithm_base)

if(GTest_FOUND)
    # numerics
    ZOS_COMPILE_GTEST("numerics/test_eigen_solver.cpp" LIBRARIES "${lib_support}")
    ZOS_COMPILE_GTEST("numerics/test_matrix.cpp" LIBRARIES "${lib_support}")
    # ... 更多测试 ...
else()
    MESSAGE(WARNING GTest not found! Disable gtest unit tests)
endif()
```

- **find_package(GTest QUIET)**：尝试查找Google Test库，QUIET表示找不到时不报错
- **ZOS_COMPILE_GTEST**：自定义宏，用于编译测试用例
- **条件判断**：仅在找到GTest时才编译测试

## 6. CMake变量和自动变量

### 6.1 常用变量
- `PROJECT_NAME`：当前项目名称
- `PROJECT_VERSION`：当前项目版本
- `PROJECT_SOURCE_DIR`：项目源代码目录
- `PROJECT_BINARY_DIR`：项目构建目录
- `CMAKE_CURRENT_SOURCE_DIR`：当前CMakeLists.txt所在目录
- `CMAKE_CURRENT_BINARY_DIR`：当前构建目录

### 6.2 自动变量
- `CMAKE_CXX_COMPILER_ID`：C++编译器ID
- `CMAKE_SYSTEM_NAME`：目标系统名称
- `CMAKE_BUILD_TYPE`：构建类型（如Debug、Release）

## 7. CMake命令分类

### 7.1 项目配置命令
- `cmake_minimum_required`
- `project`
- `set`
- `option`

### 7.2 依赖查找命令
- `find_package`
- `find_library`
- `find_path`

### 7.3 目标构建命令
- `add_executable`
- `add_library`
- `target_sources`
- `target_include_directories`
- `target_link_libraries`

### 7.4 安装命令
- `install`
- `include(CMakePackageConfigHelpers)`
- `write_basic_package_version_file`

## 8. CMake最佳实践

### 8.1 现代CMake推荐
- 使用**导入目标**（如`Eigen3::Eigen`）而不是传统变量
- 使用**target_*命令**代替全局命令
- 支持**构建树和安装树**
- 使用**命名空间**组织目标

### 8.2 项目结构
- 将头文件和源文件分开存放
- 使用一致的目录结构
- 为测试创建单独的目录

### 8.3 可移植性
- 避免硬编码路径
- 使用CMake提供的变量和命令
- 考虑不同平台的差异

## 9. 编译和构建

### 9.1 基本编译流程

```bash
# 1. 创建构建目录
mkdir build
cd build

# 2. 运行CMake生成构建文件
cmake ..

# 3. 编译项目
make

# 4. 安装项目（可选）
sudo make install
```

### 9.2 常用选项

```bash
# 指定构建类型
cmake .. -DCMAKE_BUILD_TYPE=Release

# 指定安装前缀
cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local

# 使用特定编译器
cmake .. -DCMAKE_CXX_COMPILER=g++-10
```

## 10. 总结

本教程以algorithm_base项目的CMake配置为例，介绍了CMake的核心概念、基本语法和最佳实践。通过学习这个项目的CMake配置，您应该能够理解如何：

- 初始化一个CMake项目
- 设置编译选项
- 查找和使用外部依赖
- 构建库和可执行文件
- 配置测试
- 创建和安装包

CMake是一个强大而灵活的构建系统，掌握它将大大提高您的跨平台开发效率。建议您进一步阅读CMake官方文档，深入学习更多高级特性。

## 参考资料
- [CMake官方文档](https://cmake.org/cmake/help/latest/)
- [Modern CMake](https://cliutils.gitlab.io/modern-cmake/)